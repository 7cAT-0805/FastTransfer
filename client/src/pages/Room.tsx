import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { toast } from 'react-hot-toast';
import { 
  Copy, 
  Users, 
  FileText, 
  AlertCircle,
  QrCode,
  X
} from 'lucide-react';
import apiWrapper from '../utils/api';
import socketService from '../utils/socket';
import { FileInfo, ShareMessage } from '../types';
import { copyToClipboard, generateRoomUrl } from '../utils/helpers';
import FileList from '../components/FileList';
import QRCodeGenerator from '../components/QRCodeGenerator';
import ShareAndUpload from '../components/ShareAndUpload';
import { NetworkError, useErrorHandler } from '../components/ErrorDisplay';
import { DeveloperMode } from '../utils/developerMode';

const Room: React.FC = () => {
  const { roomId } = useParams<{ roomId: string }>();
  const navigate = useNavigate();
  const { error: networkError, handleError: handleNetworkError, clearError: clearNetworkError } = useErrorHandler();
  
  const [isHost, setIsHost] = useState(false);
  const [files, setFiles] = useState<FileInfo[]>([]);
  const [participants, setParticipants] = useState(0);
  const [loading, setLoading] = useState(true);
  const [roomUrl, setRoomUrl] = useState('');
  const [connectionStatus, setConnectionStatus] = useState('connecting');
  const [showQRCode, setShowQRCode] = useState(false);
  const [messages, setMessages] = useState<ShareMessage[]>([]);
  useEffect(() => {
    if (!roomId) {
      navigate('/');
      return;
    }

    // ÂàùÂßãÂåñÈñãÁôºËÄÖÊ®°Âºè
    const devMode = DeveloperMode.getInstance();
    
    // Â¶ÇÊûúÊòØÈñãÁôºËÄÖÊ®°ÂºèÔºåÂæûÈñãÁôºËÄÖÊ®°ÂºèÁç≤ÂèñËßíËâ≤
    if (devMode.isEnabled()) {
      setIsHost(devMode.getRole());
      console.log('üõ†Ô∏è ÈñãÁôºËÄÖÊ®°ÂºèÂ∑≤ÂïüÁî®ÔºåËßíËâ≤:', devMode.getRole() ? 'Êàø‰∏ª' : 'Ë®™ÂÆ¢');
    }

    const initRoom = async () => {
      try {        // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Êàø‰∏ª
        const hostId = localStorage.getItem(`room_${roomId}_host`);
        console.log('üè† Host ID from localStorage:', hostId);
          if (hostId) {
          const response = await apiWrapper.post(`/rooms/${roomId}/verify-host`, { hostId });
          setIsHost(response.data.isHost);
          console.log('‚úÖ Is Host:', response.data.isHost);
        } else {
          // Â¶ÇÊûú‰∏çÊòØÊàø‰∏ªÔºåÂòóË©¶Âä†ÂÖ•ÊàøÈñì
          try {
            const joinResponse = await apiWrapper.post(`/rooms/${roomId}/join`);
            console.log('üë• Joined as guest:', joinResponse.data);
          } catch (error) {
            console.error('‚ùå Failed to join room:', error);
            toast.error('ÊàøÈñì‰∏çÂ≠òÂú®ÊàñÂ∑≤ÈóúÈñâ');
            navigate('/');
            return;
          }
        }// Áç≤ÂèñÊàøÈñìÊ™îÊ°àÂàóË°®
        const filesResponse = await apiWrapper.get(`/rooms/${roomId}/files`);
        setFiles(filesResponse.data.files);

        // Ë®≠ÁΩÆÊàøÈñìURL
        setRoomUrl(generateRoomUrl(roomId));        // ÈÄ£Êé• Socket.IO ‰∏¶Á≠âÂæÖÈÄ£Êé•ÂÆåÊàê
        console.log('üîå Connecting to Socket.IO with hostId:', hostId);
        setConnectionStatus('connecting');
        const socket = socketService.connect(hostId ? { hostId } : undefined);

        // Á≠âÂæÖ Socket ÈÄ£Êé•
        const waitForConnection = () => {
          return new Promise<void>((resolve) => {
            if (socket.connected) {
              console.log('‚úÖ Socket already connected');
              setConnectionStatus('connected');
              resolve();
            } else {
              socket.on('connect', () => {
                console.log('‚úÖ Socket connected successfully');
                setConnectionStatus('connected');
                resolve();
              });
              socket.on('connect_error', () => {
                setConnectionStatus('error');
              });
            }
          });
        };

        await waitForConnection();        // ÂÆöÁæ©‰∫ã‰ª∂ËôïÁêÜÂô®
        const handleFileUploaded = (fileInfo: FileInfo) => {
          setFiles(prev => {
            // Â§öÈáçÊ¢ù‰ª∂ÂéªÈáç
            const exists = prev.find(f =>
              f.id === fileInfo.id ||
              f.filename === fileInfo.filename ||
              (f.originalName === fileInfo.originalName && f.size === fileInfo.size)
            );
            if (exists) return prev;
            return [fileInfo, ...prev];
          });
        };

        const handleParticipantCountUpdate = (count: number) => {
          console.log('Êî∂Âà∞ÂèÉËàáËÄÖÊï∏ÈáèÊõ¥Êñ∞:', count);
          setParticipants(count);
        };

        const handleRoomJoined = (data: any) => {
          console.log('ÊàêÂäüÂä†ÂÖ•ÊàøÈñì:', data);
          setFiles(data.files || []);
        };        const handleError = (error: any) => {
          console.error('SocketÈåØË™§:', error);
          const errorMessage = error.message || 'ÊàøÈñìÈÄ£Êé•Â§±Êïó';
          
          // Ê™¢Êü•ÊòØÂê¶ÁÇ∫Á∂≤Ë∑ØÈåØË™§
          if (errorMessage.includes('Network') || errorMessage.includes('ÈÄ£Á∑ö') || errorMessage.includes('Á∂≤Ë∑Ø')) {
            handleNetworkError(errorMessage);
          } else {
            toast.error(errorMessage);
          }
          
          setConnectionStatus('error');
        };

        const handleRoomClosed = (data: any) => {
          console.log('ÊàøÈñìÂ∑≤ÈóúÈñâ:', data);
          toast.error(data.message || 'ÊàøÈñìÂ∑≤ÈóúÈñâ');
          navigate('/');
        };        // Ê∏ÖÈô§‰πãÂâçÁöÑÁõ£ËÅΩÂô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
        socketService.removeAllListeners();

        // Áõ£ËÅΩ‰∫ã‰ª∂
        socketService.onFileUploaded(handleFileUploaded);
        socketService.onParticipantCountUpdate(handleParticipantCountUpdate);
        socketService.onRoomJoined(handleRoomJoined);
        socketService.onError(handleError);
        socketService.onRoomClosed(handleRoomClosed);

        // Âä†ÂÖ•ÊàøÈñì
        console.log('üö™ Joining room:', roomId);
        socketService.joinRoom(roomId);

      } catch (error) {
        toast.error(error instanceof Error ? error.message : 'ÁÑ°Ê≥ïÂä†ÂÖ•ÊàøÈñì');
        navigate('/');
      } finally {
        setLoading(false);
      }
    };    initRoom();

    // ÈñãÁôºËÄÖÊ®°Âºè‰∫ã‰ª∂Áõ£ËÅΩÂô®
    const handleDevModeRoleChanged = (event: CustomEvent) => {
      console.log('üõ†Ô∏è ÈñãÁôºËÄÖÊ®°ÂºèËßíËâ≤ËÆäÊõ¥:', event.detail);
      setIsHost(event.detail.isHost);
      
      // È°ØÁ§∫ËßíËâ≤ÂàáÊèõÊèêÁ§∫
      const roleText = event.detail.isHost ? 'Êàø‰∏ª' : 'Ë®™ÂÆ¢';
      toast.success(`ÈñãÁôºËÄÖÊ®°Âºè: Â∑≤ÂàáÊèõÁÇ∫${roleText}Ë¶ñËßí`, {
        icon: event.detail.isHost ? 'üëë' : 'üë•',
        duration: 3000,
      });
    };

    const handleDevModeDataCleared = () => {
      console.log('üõ†Ô∏è ÈñãÁôºËÄÖÊ®°ÂºèÊï∏ÊìöÂ∑≤Ê∏ÖÁ©∫');
      setFiles([]);
      setMessages([]);
      toast.success('ÈñãÁôºËÄÖÊ®°Âºè: Ê∏¨Ë©¶Êï∏ÊìöÂ∑≤Ê∏ÖÁ©∫', {
        icon: 'üóëÔ∏è',
      });
    };

    const handleDevModeFileAdded = (event: CustomEvent) => {
      console.log('üõ†Ô∏è ÈñãÁôºËÄÖÊ®°ÂºèÊ∑ªÂä†Ê™îÊ°à:', event.detail.file);
      setFiles(prev => [...prev, event.detail.file]);
      toast.success(`ÈñãÁôºËÄÖÊ®°Âºè: Â∑≤Ê∑ªÂä† ${event.detail.file.originalName}`, {
        icon: 'üìÅ',
      });
    };

    const handleDevModeMessageAdded = (event: CustomEvent) => {
      console.log('üõ†Ô∏è ÈñãÁôºËÄÖÊ®°ÂºèÊ∑ªÂä†Ë®äÊÅØ:', event.detail.message);
      setMessages(prev => [...prev, event.detail.message]);
      toast.success('ÈñãÁôºËÄÖÊ®°Âºè: Â∑≤Ê∑ªÂä†Ê∏¨Ë©¶Ë®äÊÅØ', {
        icon: 'üí¨',
      });
    };

    // Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
    window.addEventListener('devModeRoleChanged', handleDevModeRoleChanged as EventListener);
    window.addEventListener('devModeDataCleared', handleDevModeDataCleared as EventListener);
    window.addEventListener('devModeFileAdded', handleDevModeFileAdded as EventListener);
    window.addEventListener('devModeMessageAdded', handleDevModeMessageAdded as EventListener);

    // Ê∏ÖÁêÜÂáΩÊï∏
    return () => {
      socketService.off('fileUploaded');
      socketService.off('participantCountUpdate');
      socketService.off('roomJoined');
      socketService.off('error');
      socketService.off('roomClosed');
      socketService.disconnect();
      
      // ÁßªÈô§ÈñãÁôºËÄÖÊ®°Âºè‰∫ã‰ª∂Áõ£ËÅΩÂô®
      window.removeEventListener('devModeRoleChanged', handleDevModeRoleChanged as EventListener);
      window.removeEventListener('devModeDataCleared', handleDevModeDataCleared as EventListener);
      window.removeEventListener('devModeFileAdded', handleDevModeFileAdded as EventListener);
      window.removeEventListener('devModeMessageAdded', handleDevModeMessageAdded as EventListener);
    };
  }, [roomId, navigate]);
  // ËôïÁêÜÂàÜ‰∫´Ë®äÊÅØ
  const handleMessageSent = (message: ShareMessage) => {
    setMessages(prev => [...prev, message]);
    // ÈÄôË£°ÂèØ‰ª•ÈÄöÈÅé Socket.IO Âª£Êí≠Ë®äÊÅØÁµ¶ÊàøÈñìÂÖ∂‰ªñÊàêÂì°
    // socketService.emit('shareMessage', message);
  };

  const handleCopyRoomUrl = async () => {
    // È°ØÁ§∫ QR Code Ê®°ÊÖãÂ∞çË©±Ê°ÜÔºåËÄå‰∏çÊòØÁõ¥Êé•Ë§áË£Ω
    setShowQRCode(true);
  };

  const handleCopyRoomCode = async () => {
    const success = await copyToClipboard(roomId || '');
    if (success) {
      toast.success('ÊàøÈñì‰ª£Á¢ºÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
    } else {
      toast.error('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£Ω');
    }  };
  // ÈáçË©¶Âä†ÂÖ•ÊàøÈñìÁöÑÂáΩÊï∏
  const retryJoinRoom = async () => {
    if (!roomId) return;
    
    clearNetworkError();
    setLoading(true);
    setConnectionStatus('connecting');
    
    try {
      console.log('üîÑ ÈáçË©¶Âä†ÂÖ•ÊàøÈñì:', roomId);
      socketService.joinRoom(roomId);
      
      // Á≠âÂæÖÈÄ£Êé•ÁµêÊûú
      setTimeout(() => {
        if (connectionStatus === 'connecting') {
          setConnectionStatus('connected');
        }
      }, 3000);
    } catch (error) {
      console.error('ÈáçË©¶Â§±Êïó:', error);
      handleNetworkError(error instanceof Error ? error.message : 'ÈáçË©¶Â§±Êïó');    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"></div>
          <p className="text-gray-600 mb-2">Ê≠£Âú®ËºâÂÖ•ÊàøÈñì...</p>
          {connectionStatus === 'connecting' && (
            <p className="text-sm text-yellow-600">Ê≠£Âú®ÈÄ£Êé•ÊúçÂãôÂô®ÔºåË´ãÁ®çÂÄô...</p>
          )}
          {connectionStatus === 'error' && (
            <p className="text-sm text-orange-600">ÊúçÂãôÂô®Ê≠£Âú®ÂïüÂãï‰∏≠ÔºåË´ãÁ®çÁ≠âÁâáÂàª...</p>
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen py-4 sm:py-8">
      <div className="max-w-6xl mx-auto px-3 sm:px-4 lg:px-8">
        {/* ÊàøÈñìË≥áË®ä */}
        <div className="card mb-6 sm:mb-8">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between">
            <div className="mb-4 md:mb-0">
              <h1 className="text-2xl sm:text-3xl font-bold text-gray-900 mb-2 sm:mb-3 text-content">
                <span className="bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                  ÊàøÈñì {roomId}
                </span>
                {isHost && (
                  <div className="inline-flex items-center ml-2 sm:ml-4 px-2 sm:px-4 py-1 sm:py-2 rounded-full text-xs sm:text-sm font-bold bg-gradient-to-r from-amber-400 via-orange-400 to-amber-500 text-white shadow-lg shadow-amber-500/30 animate-pulse">
                    <div className="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-white rounded-full mr-1 sm:mr-2 animate-ping"></div>
                    <span className="mr-1">üëë</span>
                    Êàø‰∏ª
                  </div>
                )}
              </h1>
              <div className="flex items-center space-x-3 sm:space-x-4 text-xs sm:text-sm text-gray-600">
                <div className="flex items-center">
                  <Users className="w-3 h-3 sm:w-4 sm:h-4 mr-1" />
                  <span>{participants} ‰∫∫Âú®Á∑ö</span>
                </div>
                <div className="flex items-center">
                  <FileText className="w-3 h-3 sm:w-4 sm:h-4 mr-1" />
                  <span>{files.length} ÂÄãÊ™îÊ°à</span>
                </div>
              </div>
            </div>
            <div className="flex flex-col sm:flex-row gap-2 sm:gap-3">
              <button
                onClick={handleCopyRoomCode}
                className="btn-secondary flex items-center justify-center text-xs sm:text-sm py-2 sm:py-3 px-3 sm:px-4"
              >
                <Copy className="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2" />
                Ë§áË£Ω‰ª£Á¢º
              </button>
              <button
                onClick={handleCopyRoomUrl}
                className="btn-primary flex items-center justify-center text-xs sm:text-sm py-2 sm:py-3 px-3 sm:px-4"
              >
                <QrCode className="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2" />
                ÂàÜ‰∫´ QR Code
              </button>
            </div>
          </div>

          {/* ÊàøÈñìË™™Êòé - ÁßªÂãïÁ´ØÂÑ™Âåñ */}
          <div className="mt-6 sm:mt-8 p-4 sm:p-6 bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 rounded-xl sm:rounded-2xl border border-blue-200/50 shadow-sm">
            <div className="flex">
              <AlertCircle className="w-5 h-5 sm:w-6 sm:h-6 text-blue-600 mt-0.5 mr-3 sm:mr-4 flex-shrink-0" />
              <div className="text-blue-800">
                <h3 className="text-base sm:text-lg font-bold mb-2 sm:mb-3 text-gray-900">ÊàøÈñì‰ΩøÁî®Ë™™Êòé</h3>
                <ul className="space-y-1.5 sm:space-y-2 list-none text-xs sm:text-sm text-content">
                  <li className="flex items-start">
                    <span className="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-emerald-500 rounded-full mr-2 sm:mr-3 mt-1.5 sm:mt-2 flex-shrink-0"></span>
                    <span className="text-gray-700">ÊâÄÊúâÊàêÂì°ÈÉΩÂèØ‰ª•‰∏äÂÇ≥Âíå‰∏ãËºâÊ™îÊ°àÔºå‰∫´ÂèóÁÑ°ÈôêÂà∂ÁöÑÊ™îÊ°àÂàÜ‰∫´È´îÈ©ó</span>
                  </li>
                  <li className="flex items-start">
                    <span className="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-blue-500 rounded-full mr-2 sm:mr-3 mt-1.5 sm:mt-2 flex-shrink-0"></span>
                    <span className="text-gray-700">ÊâÄÊúâÊàêÂì°ÈÉΩÂèØ‰ª•ÁôºÈÄÅÂø´ÈÄüÂàÜ‰∫´ÔºåÂåÖÊã¨ÊñáÂ≠ó„ÄÅÁ∂≤ÂùÄ„ÄÅÂâ™Ë≤ºÁ∞øÂíåË™ûÈü≥Ë®äÊÅØ</span>
                  </li>
                  <li className="flex items-start">
                    <span className="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-amber-500 rounded-full mr-2 sm:mr-3 mt-1.5 sm:mt-2 flex-shrink-0"></span>
                    <span className="text-gray-700">Êàø‰∏ªÈõ¢ÈñãÊôÇÊàøÈñìÊúÉÁ´ãÂç≥ÈóúÈñâÔºåË´ãÁ¢∫‰øùÈáçË¶ÅÊ™îÊ°àÂ∑≤‰∏ãËºâÂÆåÊàê</span>
                  </li>
                  <li className="flex items-start">
                    <span className="w-1.5 h-1.5 sm:w-2 sm:h-2 bg-red-500 rounded-full mr-2 sm:mr-3 mt-1.5 sm:mt-2 flex-shrink-0"></span>
                    <span className="text-gray-700">Ê™îÊ°àÊúÉÂú®ÊàøÈñìÈóúÈñâÊôÇÁ´ãÂç≥Âà™Èô§ÔºåÁÑ°Ê≥ïÊÅ¢Âæ©ÔºåË´ãÂèäÊôÇ‰øùÂ≠ò</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        {/* Á∂≤Ë∑ØÈåØË™§È°ØÁ§∫ */}
        {networkError && (
          <div className="mb-4 sm:mb-6">
            <NetworkError
              error={networkError}
              onRetry={retryJoinRoom}
              onDismiss={clearNetworkError}
              title="ÈÄ£Á∑öÂïèÈ°å"
            />
          </div>
        )}

        {/* ‰∏ªÂÖßÂÆπÂçÄÂüü - ÁßªÂãïÁ´ØÈüøÊáâÂºèÂ∏ÉÂ±Ä */}
        <div className="flex flex-col lg:flex-row gap-4 sm:gap-6 lg:gap-8">
          {/* Â∑¶ÂÅ¥ÔºöÁµ±‰∏ÄÁöÑ‰∏äÂÇ≥ÂíåÂàÜ‰∫´ÂçÄÂüü */}
          <div className="lg:w-1/3">
            <ShareAndUpload 
              roomId={roomId!}
              onMessageSent={handleMessageSent}
              onFileUploaded={(file) => {
                setFiles(prev => {
                  const exists = prev.find(f =>
                    f.id === file.id ||
                    f.filename === file.filename ||
                    (f.originalName === file.originalName && f.size === file.size)
                  );
                  if (exists) return prev;
                  return [file, ...prev];
                });
              }}
            />
          </div>

          {/* Âè≥ÂÅ¥ÔºöÊ™îÊ°àÂíåÂÖßÂÆπÂàóË°® */}
          <div className="lg:w-2/3">
            <FileList 
              files={files} 
              messages={messages}
              roomId={roomId!}
            />
          </div>
        </div>

        {/* QR Code Ê®°ÊÖãÂ∞çË©±Ê°Ü */}
        {showQRCode && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setShowQRCode(false)}>            <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4" onClick={(e) => e.stopPropagation()}>
              <div className="text-center relative">
                <button
                  onClick={() => setShowQRCode(false)}
                  className="absolute -top-2 -right-2 w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors"
                >
                  <X className="w-4 h-4 text-gray-600" />
                </button>
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">ÂàÜ‰∫´ÊàøÈñì</h3>
                <QRCodeGenerator roomUrl={roomUrl} roomId={roomId!} />
                <div className="mt-4">
                <button
                    onClick={async () => {
                      const success = await copyToClipboard(roomUrl);
                      if (success) {
                        toast.success('ÊàøÈñìÈÄ£ÁµêÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
                      } else {
                        toast.error('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£Ω');
                      }
                    }}
                    className="btn-secondary w-full mb-2 flex items-center justify-center"
                  >
                    <Copy className="w-4 h-4 mr-2" />
                    Ë§áË£ΩÊàøÈñìÈÄ£Áµê
                  </button>
                  <button
                    onClick={() => setShowQRCode(false)}
                    className="btn-primary w-full"
                  >
                    ÈóúÈñâ
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default Room;
